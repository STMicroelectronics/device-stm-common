From c6363bdf090a3c360a0201db499efd44f00e9809 Mon Sep 17 00:00:00 2001
From: frq09432 <nicolas.louboutin@st.com>
Date: Wed, 21 Aug 2019 11:50:28 +0200
Subject: [PATCH] eBPF programs shall return explicit value

Change-Id: Iad12e4e50347dc7270bd2b030971dae824511a73
---
 bpfloader/bpf_kern.h | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/bpfloader/bpf_kern.h b/bpfloader/bpf_kern.h
index a59cb6d..748e1ef 100644
--- a/bpfloader/bpf_kern.h
+++ b/bpfloader/bpf_kern.h
@@ -169,7 +169,7 @@ static __always_inline inline int bpf_traffic_account(struct __sk_buff* skb, int
     if ((direction == BPF_EGRESS) && (match == BPF_DROP)) {
         // If an outbound packet is going to be dropped, we do not count that
         // traffic.
-        return match;
+        return BPF_DROP;
     }
 
     uint64_t cookie = get_socket_cookie(skb);
@@ -195,5 +195,9 @@ static __always_inline inline int bpf_traffic_account(struct __sk_buff* skb, int
     key.tag = 0;
     bpf_update_stats(skb, UID_STATS_MAP, direction, &key);
     bpf_update_stats(skb, APP_UID_STATS_MAP, direction, &uid);
-    return match;
+
+    if (match == BPF_PASS)
+        return BPF_PASS;
+    else
+        return BPF_DROP;
 }
-- 
2.7.4

