From fec60fb3c844c173d2f3c697278d9c13c9c9f4cb Mon Sep 17 00:00:00 2001
From: frq09432 <nicolas.louboutin@st.com>
Date: Thu, 24 Jan 2019 18:11:14 +0100
Subject: [PATCH 1/2] check Bluetooth availability before registering callback

Change-Id: I1b5b3d8580ce6af6df8bd9205a6f555c1946d343
---
 .../settings/bluetooth/BluetoothDeviceUpdater.java     | 18 +++++++++++-------
 .../AvailableMediaDeviceGroupController.java           |  8 ++++++--
 2 files changed, 17 insertions(+), 9 deletions(-)

diff --git a/src/com/android/settings/bluetooth/BluetoothDeviceUpdater.java b/src/com/android/settings/bluetooth/BluetoothDeviceUpdater.java
index bab7171..38c4545 100644
--- a/src/com/android/settings/bluetooth/BluetoothDeviceUpdater.java
+++ b/src/com/android/settings/bluetooth/BluetoothDeviceUpdater.java
@@ -85,19 +85,23 @@ public abstract class BluetoothDeviceUpdater implements BluetoothCallback,
      * Register the bluetooth event callback and update the list
      */
     public void registerCallback() {
-        mLocalManager.setForegroundActivity(mFragment.getContext());
-        mLocalManager.getEventManager().registerCallback(this);
-        mLocalManager.getProfileManager().addServiceListener(this);
-        forceUpdate();
+        if (mLocalManager != null) {
+            mLocalManager.setForegroundActivity(mFragment.getContext());
+            mLocalManager.getEventManager().registerCallback(this);
+            mLocalManager.getProfileManager().addServiceListener(this);
+            forceUpdate();
+        }
     }
 
     /**
      * Unregister the bluetooth event callback
      */
     public void unregisterCallback() {
-        mLocalManager.setForegroundActivity(null);
-        mLocalManager.getEventManager().unregisterCallback(this);
-        mLocalManager.getProfileManager().removeServiceListener(this);
+        if (mLocalManager != null) {
+            mLocalManager.setForegroundActivity(null);
+            mLocalManager.getEventManager().unregisterCallback(this);
+            mLocalManager.getProfileManager().removeServiceListener(this);
+        }
     }
 
     /**
diff --git a/src/com/android/settings/connecteddevice/AvailableMediaDeviceGroupController.java b/src/com/android/settings/connecteddevice/AvailableMediaDeviceGroupController.java
index 6fa7d1b..1d9e8d8 100644
--- a/src/com/android/settings/connecteddevice/AvailableMediaDeviceGroupController.java
+++ b/src/com/android/settings/connecteddevice/AvailableMediaDeviceGroupController.java
@@ -59,13 +59,17 @@ public class AvailableMediaDeviceGroupController extends BasePreferenceControlle
     @Override
     public void onStart() {
         mBluetoothDeviceUpdater.registerCallback();
-        mLocalBluetoothManager.getEventManager().registerCallback(this);
+        if (mLocalBluetoothManager != null) {
+            mLocalBluetoothManager.getEventManager().registerCallback(this);
+        }
     }
 
     @Override
     public void onStop() {
         mBluetoothDeviceUpdater.unregisterCallback();
-        mLocalBluetoothManager.getEventManager().unregisterCallback(this);
+        if (mLocalBluetoothManager != null) {
+            mLocalBluetoothManager.getEventManager().unregisterCallback(this);
+        }
     }
 
     @Override
-- 
2.7.4

